# Zanjir - Docker Compose Configuration
# Self-hosted Matrix server with Synapse, Element Web, and Caddy

services:
  # PostgreSQL Database
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:15-alpine}
    container_name: zanjir-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-synapse}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-synapse}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - zanjir-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-synapse}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Synapse Matrix Homeserver
  synapse-init:
    image: ${SYNAPSE_IMAGE:-matrixdotorg/synapse:v1.114.0}
    container_name: zanjir-synapse-init
    user: "0:0"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Fixing Synapse data permissions..."
        chown -R ${SYNAPSE_UID:-991}:${SYNAPSE_GID:-991} /data
        chmod -R u+rwX /data
        echo "Synapse data permissions fixed."
    volumes:
      - synapse-data:/data
    networks:
      - zanjir-network

  synapse:
    image: ${SYNAPSE_IMAGE:-matrixdotorg/synapse:v1.114.0}
    container_name: zanjir-synapse
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      synapse-init:
        condition: service_completed_successfully
    environment:
      SYNAPSE_SERVER_NAME: ${DOMAIN}
      SYNAPSE_REPORT_STATS: "no"
    volumes:
      - synapse-data:/data
      - ./synapse/homeserver.yaml:/data/homeserver.yaml:ro
      - ./synapse/log.config:/data/log.config:ro
    networks:
      - zanjir-network

  # Element Web Client
  element:
    image: ${ELEMENT_IMAGE:-vectorim/element-web:v1.11.50}
    container_name: zanjir-element
    restart: unless-stopped
    volumes:
      - ./config/element-config.json:/app/config.json:ro
      - ./config/welcome.html:/app/welcome.html:ro
    networks:
      - zanjir-network

  # Caddy Reverse Proxy with Automatic HTTPS
  caddy:
    image: ${CADDY_IMAGE:-caddy:2-alpine}
    container_name: zanjir-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN}
      SERVER_ADDRESS: ${SERVER_ADDRESS:-${DOMAIN}}
    volumes:
      - ./Caddyfile.active:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      # Mount Element Web files for serving
      - element-web:/srv/element:ro
    networks:
      - zanjir-network
    depends_on:
      - synapse
      - element

  # Utility container to copy Element Web files
  element-copy:
    image: ${ELEMENT_COPY_IMAGE:-vectorim/element-web:v1.11.50}
    container_name: zanjir-element-copy
    user: root
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cp -r /app/* /srv/element/
        cp /config/config.json /srv/element/config.json
        cp /config/welcome.html /srv/element/welcome.html
        cp /config/logo.webp /srv/element/logo.webp
        mkdir -p /srv/element/mobile_guide
        cp /config/mobile_guide.html /srv/element/mobile_guide/index.html
        echo "Element Web files copied successfully"
    volumes:
      - element-web:/srv/element
      - ./config/element-config.json:/config/config.json:ro
      - ./config/welcome.html:/config/welcome.html:ro
      - ./config/logo.webp:/config/logo.webp:ro
      - ./config/mobile_guide.html:/config/mobile_guide.html:ro
    networks:
      - zanjir-network

networks:
  zanjir-network:
    driver: bridge

volumes:
  postgres-data:
    name: zanjir-postgres-data
  synapse-data:
    name: zanjir-synapse-data
  caddy-data:
    name: zanjir-caddy-data
  caddy-config:
    name: zanjir-caddy-config
  element-web:
    name: zanjir-element-web
